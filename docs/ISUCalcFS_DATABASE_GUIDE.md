# Полная расшифровка базы данных ISUCalcFS
## Система подсчёта баллов фигурного катания ISU

**Версия программы:** 3.7.6  
**Правила сезона:** 2021-2022  
**Версия структуры БД:** 11149  
**Кодировка:** CP1251 (Windows-1251)  
**Формат файлов:** dBase/FoxPro (.DBF) + индексы (.CDX)

---

## 1. ОБЩАЯ АРХИТЕКТУРА БАЗЫ ДАННЫХ

### 1.1 Типы файлов
| Расширение | Описание |
|------------|----------|
| `.DBF` | Файл данных dBase/FoxPro |
| `.CDX` | Составной индексный файл FoxPro |

### 1.2 Типы данных в полях DBF
| Код | Тип | Описание |
|-----|-----|----------|
| C | Character | Строка (текст) |
| N | Numeric | Число (целое или с дробной частью) |
| D | Date | Дата (YYYYMMDD) |
| L | Logical | Логическое (T/F) |
| M | Memo | Большой текст (хранится в FPT файле) |

---

## 2. СПРАВОЧНИК ТАБЛИЦ

### 2.1 ОСНОВНЫЕ ТАБЛИЦЫ

#### **EVT.DBF** - События/Соревнования (Events)
Главная таблица соревнования.

| Поле | Тип | Описание |
|------|-----|----------|
| EVT_ID | N(8) | Уникальный ID соревнования |
| EVT_NAME | C(50) | Название соревнования |
| EVT_LNAME | C(50) | Полное название |
| EVT_SNAME | C(10) | Короткое название |
| EVT_PLACE | C(50) | Место проведения |
| EVT_BEGDAT | D | Дата начала |
| EVT_ENDDAT | D | Дата окончания |
| EVT_REPPID | N(8) | ID представителя |
| EVT_TD1PID | N(8) | ID Технического делегата 1 |
| EVT_TD2PID | N(8) | ID Технического делегата 2 |
| EVT_TD3PID | N(8) | ID Технического делегата 3 |
| EVT_PLANG | C(1) | Язык протоколов (E=English, R=Russian) |
| EVT_TYPE | C(1) | Тип (T=Tournament) |
| EVT_CMPTYP | C(1) | Тип соревнования (L=Local) |
| EVT_STAT | C(1) | Статус (A=Active) |
| EVT_NATION | C(3) | Страна |

---

#### **CAT.DBF** - Категории (Categories)
Возрастные группы и дисциплины.

| Поле | Тип | Описание |
|------|-----|----------|
| CAT_ID | N(8) | Уникальный ID категории |
| EVT_ID | N(8) | Ссылка на соревнование |
| TEC_ID | N(8) | ID технической панели |
| CAT_NAME | C(50) | Название категории |
| CAT_TVNAME | C(50) | Название для ТВ |
| CAT_NENT | N(2) | Количество заявленных участников |
| CAT_NPAR | N(2) | Количество участников в старте |
| CAT_LEVEL | C(1) | Уровень (m=мастер, 1,2,3=юниоры) |
| CAT_GENDER | C(1) | Пол (F=женский, M=мужской, T=смешанный) |
| CAT_TYPE | C(1) | Тип (S=Singles одиночное, D=Dance танцы, P=Pairs пары) |
| CAT_STAT | C(1) | Статус (A=Active) |
| CAT_SCPID1-6 | N(8) | ID сегментов программы (до 6 сегментов) |
| CAT_SCPSN1-6 | C(3) | Короткие названия сегментов (КП, ПП и т.д.) |

**Значения CAT_LEVEL:**
- `m` - Мастера (взрослые)
- `1` - 1 юношеский разряд
- `2` - 2 юношеский разряд  
- `3` - 3 юношеский разряд

**Значения CAT_TYPE:**
- `S` - Singles (одиночное катание)
- `D` - Dance (танцы на льду)
- `P` - Pairs (парное катание)

---

#### **PCT.DBF** - Участники/Клубы/Персонал (Participants/Clubs/Team)
Универсальная таблица для всех сущностей.

| Поле | Тип | Описание |
|------|-----|----------|
| PCT_ID | N(8) | Уникальный ID |
| PCT_TYPE | C(3) | Тип записи: CLU=Клуб, PER=Персона, TEA=Команда |
| PCT_AFUNCT | C(3) | Функция: CMP=Competitor (спортсмен), JDG=Judge, REP=Representative |
| PCT_STAT | C(1) | Статус (A=Active) |
| PCT_CNAME | C(60) | Полное имя |
| PCT_SNAME | C(8) | Короткое имя |
| PCT_PLNAME | C(73) | Имя для протоколов |
| PCT_GNAME | C(30) | Имя |
| PCT_FNAME | C(30) | Фамилия |
| PCT_FNAMEC | C(30) | Фамилия капитализированная |
| PCT_GENDER | C(1) | Пол (F/M) |
| PCT_BDAY | D | Дата рождения |
| PCT_NAT | C(3) | Национальность |
| PCT_CLBID | N(8) | ID клуба |
| PCT_COANAM | C(40) | Имя тренера |
| PCT_SPMNAM | C(80) | Музыка короткой программы |
| PCT_FSMNAM | C(80) | Музыка произвольной программы |
| PCT_COMENT | C(40) | Комментарий (разряд) |

---

#### **PAR.DBF** - Участники категории (Participants in Category)
Связь спортсменов с категориями и их результаты.

| Поле | Тип | Описание |
|------|-----|----------|
| PAR_ID | N(8) | Уникальный ID записи |
| PCT_ID | N(8) | Ссылка на участника (PCT) |
| CAT_ID | N(8) | Ссылка на категорию |
| PAR_STAT | C(1) | Статус: A=Active, Q=Qualified, R=Retired, W=Withdrawn |
| PAR_NAT | C(5) | Национальность |
| PAR_ENTNUM | N(2) | Номер заявки |
| PAR_POINT1-6 | N(5) | Баллы за сегменты 1-6 |
| PAR_PLACE1-6 | N(2) | Места за сегменты |
| PAR_TPOINT | N(6) | Общая сумма баллов |
| PAR_TPLACE | N(2) | Итоговое место |
| PAR_INDEX | N(2) | Индекс в списке |
| PAR_WRANK | N(4) | Мировой рейтинг |
| PAR_WSPTS | N(6) | Баллы мирового рейтинга |

**Статусы PAR_STAT:**
- `A` - Active (активный)
- `Q` - Qualified (квалифицировался)
- `R` - Retired (снялся)
- `W` - Withdrawn (отозван)

---

### 2.2 ТАБЛИЦЫ ЭЛЕМЕНТОВ И ОЦЕНОК

#### **ELM.DBF** - Справочник элементов (Elements)
База всех возможных элементов фигурного катания (2854 записи).

| Поле | Тип | Описание |
|------|-----|----------|
| ELM_ID | N(8) | Уникальный ID элемента |
| ELM_SORT | C(8) | Код сортировки |
| ELM_SNAME | C(20) | Короткое название (3S, 2A, CCoSp4) |
| ELM_SNAMWL | C(20) | Название без уровня |
| ELM_NAME | C(50) | Полное название (Triple Salchow) |
| ELM_GROUP | C(1) | Группа: J=Jump, S=Spin, T=Step, L=Lift, C=Compulsory |
| ELM_TYPE | C(1) | Тип элемента |
| ELM_CALCGR | C(1) | Группа расчёта |
| ELM_VAL1-11 | N(5,2) | Значения GOE от -5 до +5 |
| ELM_CALCBV | N(5,2) | Базовая стоимость (Base Value) |

**Примеры элементов:**
- `3S` - Triple Salchow (тройной сальхов)
- `2A` - Double Axel (двойной аксель)
- `3Lz+2T` - Triple Lutz + Double Toeloop (комбинация)
- `CCoSp4` - Change Foot Combination Spin Level 4
- `LSp` - Layback Spin
- `StSq` - Step Sequence

---

#### **SCP.DBF** - Сегменты программы (Segments/Competition Parts)
Определение частей соревнования.

| Поле | Тип | Описание |
|------|-----|----------|
| SCP_ID | N(8) | Уникальный ID сегмента |
| CAT_ID | N(8) | Ссылка на категорию |
| SCP_NAME | C(50) | Название (Короткая программа, Произвольная программа) |
| SCP_SNAME | C(3) | Код (КП, ПП, РТ - ритм-танец) |
| SCP_NELEM | N(2) | Количество элементов |
| SCP_NCOMP | N(2) | Количество компонентов |
| SCP_FACTOR | N(4,2) | Коэффициент |
| SCP_DATE | D | Дата проведения |

---

#### **PRF.DBF** - Результаты выступлений (Performance Results)
Детальные результаты каждого выступления (571 запись).

| Поле | Тип | Описание |
|------|-----|----------|
| PRF_ID | N(8) | Уникальный ID |
| PAR_ID | N(8) | Ссылка на участника в категории |
| SCP_ID | N(8) | Ссылка на сегмент |
| PRF_STNUM | N(2) | Стартовый номер |
| PRF_STGNUM | N(2) | Номер группы старта |
| PRF_PLACE | N(2) | Место в сегменте |
| PRF_INDEX | N(2) | Индекс |
| PRF_POINTS | N(5) | Общие баллы за сегмент |
| PRF_STAT | C(1) | Статус: O=OK, L=Last, M=Missing |
| PRF_M1TOT | N(5) | Сумма TES (Technical Element Score) |
| PRF_M1RES | N(5) | Итог TES |
| PRF_M2TOT | N(5) | Сумма PCS (Program Component Score) |
| PRF_M2RES | N(5) | Итог PCS |
| PRF_PNAE01-20 | C(100) | Названия планируемых элементов |
| PRF_XNAE01-20 | C(100) | Названия исполненных элементов |
| PRF_XBVE01-20 | N(5) | Базовые стоимости элементов |
| PRF_E01J01-15 | N(2) | GOE от судей (1-15) за элемент 1 |
| PRF_E01PNL | N(5) | Штраф/бонус элемента 1 |
| PRF_E01RES | N(5) | Итоговый балл элемента 1 |
| PRF_C01J01-15 | N(5) | Оценки судей за компонент 1 |
| PRF_C01PNL | N(5) | Штраф компонента |
| PRF_C01RES | N(5) | Итог компонента |
| PRF_DED01-17 | N(5) | Вычеты (Deductions) |

---

#### **JES.DBF** - Судейские оценки элементов (Judge Element Scores)
Детальные оценки судей за каждый элемент (54 записи).

| Поле | Тип | Описание |
|------|-----|----------|
| JES_ID | N(8) | Уникальный ID |
| PAR_ID | N(8) | Ссылка на участника |
| SCP_ID | N(8) | Ссылка на сегмент |
| JES_STNUM | N(2) | Стартовый номер |
| JES_PLACE | N(2) | Место |
| JES_J01E01-J15E20 | N(2) | GOE судьи J за элемент E |
| JES_MINE01-20 | N(2) | Минимальный GOE за элемент |
| JES_GOAV01-20 | N(6) | Средний GOE за элемент |
| JES_ELBO01-20 | N(6) | Бонус элемента |
| JES_J01C01-J15C10 | N(5) | Оценки судьи J за компонент C |
| JES_CRAV01-10 | N(5) | Средняя оценка компонента |
| JES_J01TES-J15TES | N(5) | TES по мнению каждого судьи |
| JES_J01TCS-J15TCS | N(5) | TCS по мнению каждого судьи |
| JES_J01TSS-J15TSS | N(5) | TSS по мнению каждого судьи |
| JES_D01NAM-D17NAM | C(50) | Названия вычетов |
| JES_D01VAL-D17VAL | N(5) | Значения вычетов |

**Значения GOE для оценок судей (PRF_E{idx}J{idx}):**
- Полная шкала от -5 до +5
- Коды 0-15 декодируются по формуле:
  - `0` → -5
  - `1-7` → code - 4 (1→-3, 2→-2, 3→-1, 4→0, 5→+1, 6→+2, 7→+3)
  - `8` → +4
  - `9` → None (не используется)
  - `10` → +5
  - `11-12` → code - 16 (11→-5, 12→-4)
  - `13-14` → code - 9 (13→+4, 14→+5)
  - `15` → -1 (code - 16)

**Подробнее:** См. `docs/GOE_DECODING.md`
- `-1` → Не оценивался

---

#### **PEL.DBF** - Запланированные элементы (Planned Elements)
Элементы, заявленные участниками для программ (134 записи).

| Поле | Тип | Описание |
|------|-----|----------|
| PEL_ID | N(8) | Уникальный ID |
| PCT_ID | N(8) | Ссылка на участника |
| PEL_1NAE01-20 | C(100) | Короткие названия элементов программы 1 |
| PEL_1NLE01-20 | C(100) | Полные названия элементов программы 1 |
| PEL_1TCE01-20 | C(4) | Коды техпанели |
| PEL_2NAE01-20 | C(100) | Элементы программы 2 |
| PEL_1CATYP | C(1) | Тип категории для программы 1 |
| PEL_1PBEST | N(5) | Личный рекорд программы 1 |

---

### 2.3 ТАБЛИЦЫ СУДЕЙСКОЙ ПАНЕЛИ

#### **JPS.DBF** - Судейская панель сегмента (Judge Panel Segment)
Состав судейской бригады на сегмент (192 записи).

| Поле | Тип | Описание |
|------|-----|----------|
| JPS_ID | N(8) | Уникальный ID |
| SCP_ID | N(8) | Ссылка на сегмент |
| JPS_SORT | C(1) | Порядок сортировки |
| JPS_TYPE | C(50) | Тип должности |
| PCT_ID | N(8) | Ссылка на персону |
| JPS_NAT | C(5) | Национальность судьи |

---

#### **TEC.DBF** - Технический контроллер (Technical Controller)
Данные о технической панели.

#### **TCC.DBF** - Вызовы техпанели (Technical Calls)
Решения технической панели по элементам.

---

### 2.4 ВСПОМОГАТЕЛЬНЫЕ ТАБЛИЦЫ

#### **CFG.DBF** - Конфигурация базы (Configuration)

| Поле | Тип | Описание |
|------|-----|----------|
| CFG_ID | N(8) | ID |
| EVT_ID | N(8) | Ссылка на событие |
| CFG_DBFVER | N(8) | Версия структуры БД (11149) |
| CFG_CALVER | C(20) | Версия программы (3.7.6) |
| CFG_RULSES | C(10) | Сезон правил (2021-2022) |

---

#### **NAT.DBF** - Национальности (Nationalities)

| Поле | Тип | Описание |
|------|-----|----------|
| NAT_ID | N(8) | Уникальный ID |
| NAT_ISU | C(5) | Код ISU (RUS, USA, JPN) |
| NAT_NAME | C(100) | Полное название |
| NAT_ISO | C(5) | Код ISO |
| NAT_IOC | C(5) | Код МОК |

---

#### **MOT.DBF** - Члены команды (Members of Team)
Связь участников с командами (194 записи).

| Поле | Тип | Описание |
|------|-----|----------|
| MOT_ID | N(8) | ID записи |
| MOT_TYPE | C(1) | Тип участника |
| TEAM_ID | N(8) | ID команды |
| PCT_ID | N(8) | ID участника |

---

#### **DGR.DBF** - Вычеты (Deduction Groups)
Справочник типов вычетов.

| Поле | Тип | Описание |
|------|-----|----------|
| DGR_ID | N(8) | ID |
| DGR_NAME | C(10) | Код вычета |
| DGR_DESC | C(50) | Описание (Time violation, Fall, etc.) |
| DGR_POINTS | N(4,1) | Значение вычета |

---

#### **BST.DBF** - Лучшие результаты (Best Scores)
Личные рекорды участников.

| Поле | Тип | Описание |
|------|-----|----------|
| BST_ID | N(8) | ID |
| PCT_ID | N(8) | ID участника |
| BST_CATTYP | C(1) | Тип категории |
| BST_1PBSCR | N(6) | 1-й лучший результат |
| BST_1PBEVT | C(60) | Событие 1-го результата |
| BST_1PBDAT | D | Дата 1-го результата |
| BST_2PBSCR-8PBSCR | N(6) | Последующие лучшие результаты |

---

## 3. СВЯЗИ МЕЖДУ ТАБЛИЦАМИ

```
EVT (Соревнование)
 │
 ├──► CAT (Категории)
 │     │
 │     ├──► PAR (Участники категории) ◄── PCT (Персоны/Клубы)
 │     │     │
 │     │     └──► PRF (Результаты выступлений)
 │     │           │
 │     │           ├──► JES (Судейские оценки)
 │     │           └──► Связь с ELM (Элементы)
 │     │
 │     └──► SCP (Сегменты)
 │           │
 │           ├──► JPS (Судейская панель)
 │           └──► TCC (Вызовы техпанели)
 │
 └──► OPE (Официальные лица)
```

---

## 4. РАСШИФРОВКА БАЛЛОВ

### 4.1 Структура оценки по системе ISU

**Общий балл (Total Segment Score - TSS):**
```
TSS = TES + PCS - Deductions
```

**Технический балл (Technical Element Score - TES):**
```
TES = Σ (Base Value × GOE Factor) для всех элементов
```

**Компоненты программы (Program Component Score - PCS):**
- Skating Skills (навыки катания)
- Transitions (связки)
- Performance (исполнение)  
- Composition (композиция)
- Interpretation (интерпретация)

### 4.2 Формула расчёта GOE

**ВАЖНО:** Оценки судей (PRF_E{idx}J{idx}) хранятся в XML как коды 0-15 и декодируются при чтении.

GOE судей имеет полную шкалу от -5 до +5. Формула декодирования:
- Коды 0-7, 8, 10: основная шкала
- Коды 11-15: альтернативное кодирование

```python
# Декодирование GOE оценки судьи из XML кода
def decode_judge_score_xml(code):
    """Декодирование GOE оценки судьи из XML формата ISUCalcFS"""
    if code is None or code == 9:
        return None  # Не используется
    if code == 0:
        return -5
    if 1 <= code <= 7:
        return code - 4  # 1→-3, 2→-2, 3→-1, 4→0, 5→+1, 6→+2, 7→+3
    if code == 8:
        return 4
    if code == 10:
        return 5
    if 11 <= code <= 12:
        return code - 16  # 11→-5, 12→-4
    if 13 <= code <= 14:
        return code - 9  # 13→+4, 14→+5
    if code == 15:
        return -1
    return None
```

**Подробнее:** См. `docs/GOE_DECODING.md`

### 4.3 Бонус за вторую половину программы

Элементы, выполненные во второй половине программы, получают бонус **10%** к базовой стоимости.
Это относится только к **прыжковым элементам** (jumps).

В базе данных это отмечается атрибутом `PRF_E{idx}HLF`:
- `1` = первая половина программы
- `2` = вторая половина программы (бонус 10%)

В протоколе такие элементы помечаются символом **(x)** рядом с базовой стоимостью.

**Пример:**
```xml
<Performance 
    PRF_E08HLF="2"      <!-- Элемент 8 выполнен во второй половине -->
    PRF_E08WBP="1"      <!-- Бонус применен -->
    PRF_XBVE08="539"    <!-- Базовая стоимость: 5.39 -->
/>
```

В протоколе отображается как: **5.39 x** (базовая стоимость уже увеличена на 10%)

### 4.3 Множители для баллов

Баллы в базе часто хранятся умноженными на 100 для избежания дробей:
```python
# Конвертация балла
real_score = db_score / 100  # Например: 5439 → 54.39
```

---

## 5. ИНСТРУКЦИЯ ПО РАБОТЕ С БАЗОЙ

### 5.1 Чтение DBF файлов (Python)

```python
from dbfread import DBF

# Открытие файла
table = DBF('c:/ISUCalcFS/pm 2026/PCT.DBF', 
            encoding='cp1251', 
            ignore_missing_memofile=True)

# Чтение записей
for record in table:
    print(record['PCT_CNAME'], record['PCT_GENDER'])
```

### 5.2 Получение результатов соревнования

```python
# Получить всех участников категории с результатами
def get_category_results(cat_id):
    par_table = DBF('PAR.DBF', encoding='cp1251')
    pct_table = DBF('PCT.DBF', encoding='cp1251')
    
    # Создать словарь участников
    participants = {r['PCT_ID']: r for r in pct_table}
    
    results = []
    for par in par_table:
        if par['CAT_ID'] == cat_id and par['PAR_STAT'] in ['A', 'Q']:
            pct = participants.get(par['PCT_ID'])
            results.append({
                'place': par['PAR_TPLACE'],
                'name': pct['PCT_PLNAME'] if pct else 'Unknown',
                'score': par['PAR_TPOINT'] / 100,
                'sp_score': par['PAR_POINT1'] / 100,
                'fp_score': par['PAR_POINT2'] / 100 if par['PAR_POINT2'] else 0
            })
    
    return sorted(results, key=lambda x: x['place'])
```

### 5.3 Получение деталей выступления

```python
def get_performance_details(prf_id):
    prf_table = DBF('PRF.DBF', encoding='cp1251')
    
    for prf in prf_table:
        if prf['PRF_ID'] == prf_id:
            elements = []
            for i in range(1, 21):
                elem_name = prf[f'PRF_XNAE{i:02d}']
                if elem_name and elem_name.strip():
                    base_value = prf[f'PRF_XBVE{i:02d}'] / 100
                    result = prf[f'PRF_E{i:02d}RES'] / 100
                    elements.append({
                        'name': elem_name.strip(),
                        'base_value': base_value,
                        'score': result
                    })
            return {
                'tes': prf['PRF_M1RES'] / 100,
                'pcs': prf['PRF_M2RES'] / 100,
                'total': prf['PRF_POINTS'] / 100,
                'elements': elements
            }
```

---

## 6. ПАПКА $$UPDATE

Папка `$$update` содержит обновления справочников от ISU:
- Обновлённые базовые стоимости элементов
- Новые правила
- Справочники национальностей и т.д.

---

## 7. HTML ПАПКА

Папка `html` содержит сгенерированные протоколы:
- `CAT001EN.HTM` - Категория 1 на английском
- `SEG012.HTM` - Результаты сегмента 12
- `SEG012OF.HTM` - Официальный протокол сегмента
- `*_Scores.pdf` - PDF версии протоколов

---

## 8. СПРАВОЧНИК АББРЕВИАТУР

### Элементы прыжков
| Код | Название |
|-----|----------|
| A | Axel (Аксель) |
| Lz | Lutz (Лутц) |
| F | Flip (Флип) |
| Lo | Loop (Риттбергер) |
| S | Salchow (Сальхов) |
| T | Toe loop (Тулуп) |

### Элементы вращений
| Код | Название |
|-----|----------|
| USp | Upright Spin (вращение стоя) |
| LSp | Layback Spin (заклон) |
| CSp | Camel Spin (либела) |
| SSp | Sit Spin (волчок) |
| CCoSp | Change Foot Combination Spin |
| FCSp | Flying Camel Spin |

### Другие элементы
| Код | Название |
|-----|----------|
| StSq | Step Sequence (дорожка шагов) |
| ChSq | Choreographic Sequence |
| Li | Lift (поддержка) |
| Tw | Twist (подкрутка) |
| Th | Throw (выброс) |

---

## 9. ЗАКЛЮЧЕНИЕ

База данных ISUCalcFS представляет собой полноценную систему учёта соревнований по фигурному катанию, соответствующую стандартам ISU. Структура позволяет:

1. Хранить данные об участниках, клубах, судьях
2. Вести полную историю выступлений
3. Рассчитывать баллы по официальным правилам
4. Генерировать протоколы соревнований

**Автор документации:** Анализ выполнен на основе реальной базы данных соревнования "Первенство Москвы" (19-23 января 2026).
