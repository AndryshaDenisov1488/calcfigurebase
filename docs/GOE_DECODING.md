# Расшифровка GOE (Grade of Execution) в XML файлах ISUCalcFS

## Общая информация

GOE (Grade of Execution) - это оценка качества исполнения элемента в фигурном катании. Шкала GOE всегда от **-5 до +5**, где:
- **-5** - очень плохое исполнение (падение, серьезные ошибки)
- **0** - среднее исполнение (базовая стоимость элемента)
- **+5** - превосходное исполнение (отличное качество)

## Кодирование GOE в XML

В XML файлах ISUCalcFS GOE кодируется числами от 0 до 15. Каждый код соответствует определенному значению GOE.

### Таблица расшифровки для оценок судей (J01-J15)

**ВАЖНО:** Оценки судей имеют полную шкалу от -5 до +5, в отличие от общего GOE.

| Код в XML | Значение GOE | Описание | Формула |
|-----------|--------------|----------|---------|
| **0** | **-5** | Очень плохое исполнение | -5 |
| **1** | **-3** | Ниже среднего | code - 4 |
| **2** | **-2** | Немного ниже среднего | code - 4 |
| **3** | **-1** | Чуть ниже среднего | code - 4 |
| **4** | **0** | Среднее (базовая стоимость) | code - 4 |
| **5** | **+1** | Чуть выше среднего | code - 4 |
| **6** | **+2** | Немного выше среднего | code - 4 |
| **7** | **+3** | Хорошее исполнение | code - 4 |
| **8** | **+4** | Отличное исполнение | +4 |
| **9** | **None** | Не используется / Пусто | None |
| **10** | **+5** | Превосходное исполнение | +5 |
| **11** | **-5** | Альтернативное кодирование -5 | code - 16 |
| **12** | **-4** | Альтернативное кодирование -4 | code - 16 |
| **13** | **+4** | Альтернативное кодирование +4 | code - 9 |
| **14** | **+5** | Альтернативное кодирование +5 | code - 9 |
| **15** | **-1** | Альтернативное кодирование -1 | code - 16 |

## Формула преобразования для оценок судей

### Python реализация

```python
def decode_judge_score_xml(code):
    """Расшифровка кода оценки судьи из XML в значение GOE (-5..+5)."""
    if code is None:
        return None
    
    code = str(code).strip()
    if not code:
        return None
    
    try:
        code_int = int(code)
    except ValueError:
        return None
    
    # Код 9 - не используется
    if code_int == 9:
        return None
    
    # Код 0: -5
    if code_int == 0:
        return -5
    
    # Коды 1-7: code - 4
    if 1 <= code_int <= 7:
        return code_int - 4  # 1→-3, 2→-2, 3→-1, 4→0, 5→+1, 6→+2, 7→+3
    
    # Код 8: +4
    if code_int == 8:
        return 4
    
    # Код 10: +5
    if code_int == 10:
        return 5
    
    # Коды 11-12: code - 16 (отрицательные значения)
    if 11 <= code_int <= 12:
        return code_int - 16  # 11→-5, 12→-4
    
    # Коды 13-14: code - 9 (положительные значения +4 и +5)
    if 13 <= code_int <= 14:
        return code_int - 9  # 13→+4, 14→+5
    
    # Код 15: code - 16
    if code_int == 15:
        return 15 - 16  # 15→-1
    
    return None
```

## Примеры из реальных XML данных

### Пример 1: Элемент с кодом 14 (GOE = +5)
```xml
<Performance PRF_E01J01="14" PRF_E01J02="14" PRF_E01J03="14" PRF_E01J04="14" PRF_E01J05="14"/>
```
**Результат:** J1=+5, J2=+5, J3=+5, J4=+5, J5=+5

### Пример 2: Элемент с кодом 13 (GOE = +4)
```xml
<Performance PRF_E02J01="13" PRF_E02J02="13" PRF_E02J03="13" PRF_E02J04="13" PRF_E02J05="13"/>
```
**Результат:** J1=+4, J2=+4, J3=+4, J4=+4, J5=+4

### Пример 3: Элемент с кодом 7 (GOE = +3)
```xml
<Performance PRF_E03J01="7" PRF_E03J02="7" PRF_E03J03="7" PRF_E03J04="7" PRF_E03J05="7"/>
```
**Результат:** J1=+3, J2=+3, J3=+3, J4=+3, J5=+3

### Пример 4: Элемент с кодом 4 (GOE = 0)
```xml
<Performance PRF_E06J01="4" PRF_E06J02="4" PRF_E06J03="4" PRF_E06J04="4" PRF_E06J05="4"/>
```
**Результат:** J1=0, J2=0, J3=0, J4=0, J5=0

### Пример 5: Элемент с кодом 12 (GOE = -4)
```xml
<Performance PRF_E10J01="12" PRF_E10J02="12" PRF_E10J03="12" PRF_E10J04="12" PRF_E10J05="12"/>
```
**Результат:** J1=-4, J2=-4, J3=-4, J4=-4, J5=-4

### Пример 6: Элемент с кодом 11 (GOE = -5)
```xml
<Performance PRF_E01J01="11" PRF_E01J02="11" PRF_E01J03="11" PRF_E01J04="9" PRF_E01J05="9"/>
```
**Результат:** J1=-5, J2=-5, J3=-5, J4=None, J5=None

## Расположение в XML

GOE коды хранятся в атрибутах элементов `Performance` в следующем формате:
- `PRF_E{idx}J{jidx}` - где:
  - `{idx}` - номер элемента (01-20)
  - `{jidx}` - номер судьи (01-15)

**Пример:**
```xml
<Performance 
    PRF_E01J01="11"  <!-- Элемент 1, Судья 1: GOE = -5 -->
    PRF_E01J02="11"  <!-- Элемент 1, Судья 2: GOE = -5 -->
    PRF_E01J03="11"  <!-- Элемент 1, Судья 3: GOE = -5 -->
/>
```

## Важные замечания

1. **Оценки судей имеют полную шкалу от -5 до +5** (в отличие от общего GOE, который может быть ограничен)
2. **Коды 0-7** - основная шкала GOE от -5 до +3 (формула: code - 4 для 1-7, код 0 = -5)
3. **Код 8** - +4 (отличное исполнение)
4. **Код 9** - не используется, означает отсутствие оценки
5. **Код 10** - +5 (превосходное исполнение)
6. **Коды 11-12** - альтернативное кодирование для отрицательных значений (11→-5, 12→-4, формула: code - 16)
7. **Коды 13-14** - альтернативное кодирование для положительных значений (13→+4, 14→+5, формула: code - 9)
8. **Код 15** - альтернативное кодирование -1 (формула: code - 16)

## Использование в проекте

Функции расшифровки GOE находятся в файле:
- `parsers/isu_calcfs_parser.py`:
  - `_decode_goe_xml()` - для общего GOE (используется редко)
  - `_decode_judge_score_xml()` - для оценок судей (основная функция)

**ВАЖНО:** 
- Оценки судей хранятся в БД как коды (0-15), **не декодируются при сохранении**
- Декодирование происходит при чтении из БД в API endpoint `/api/participant/<id>/performance-details`
- Это позволяет исправлять формулу декодирования без переимпорта данных

## Бонус за вторую половину программы

Элементы, выполненные во второй половине программы, получают бонус 10% к базовой стоимости.
В XML это отмечается атрибутом `PRF_E{idx}HLF="2"` (где 1 = первая половина, 2 = вторая половина).
В протоколе такие элементы помечаются символом **(x)** рядом с базовой стоимостью.

**Пример:**
```xml
<Performance 
    PRF_E08HLF="2"  <!-- Элемент 8 выполнен во второй половине -->
    PRF_XBVE08="539"  <!-- Базовая стоимость: 5.39 -->
/>
```
В протоколе отображается как: **5.39 x** (базовая стоимость уже увеличена на 10%)

## История изменений

- **2026-01-25**: Исправлена формула для кодов 11-15 (было `code_int - 10`, стало `code_int - 16`)
- **2026-01-25**: Создана отдельная функция `_decode_judge_score_xml()` для оценок судей с полной шкалой -5..+5
- **2026-01-25**: Исправлена формула декодирования оценок судей на основе реальных XML данных:
  - Коды 1-7: `code - 4` (вместо `code - 5`)
  - Коды 13-14: `code - 9` (для +4 и +5)
  - Коды 11-12, 15: `code - 16` (для отрицательных значений)
- **2026-01-25**: Изменен формат хранения: оценки судей теперь хранятся как коды (0-15) в БД, декодируются при чтении
- **2026-01-25**: Добавлена обработка бонуса за вторую половину программы (PRF_E{idx}HLF, PRF_E{idx}WBP)
