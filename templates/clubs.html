{% extends "base.html" %}

{% block title %}Школы и клубы - Система управления турнирами{% endblock %}

{% block extra_css %}
<style>
    /* Мобильная адаптация для страницы школ */
    @media (max-width: 768px) {
        .card-header .d-flex {
            flex-direction: column;
            align-items: stretch !important;
            gap: 0.75rem;
        }
        
        .card-header .form-control {
            width: 100% !important;
            margin-right: 0 !important;
            margin-bottom: 0.5rem;
        }
        
        .card-header .badge {
            align-self: flex-start;
        }
        
        .table-responsive {
            font-size: 0.875rem;
        }
        
        .table th,
        .table td {
            padding: 0.5rem 0.25rem;
        }
        
        .badge {
            font-size: 0.75rem;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
    }
    
    @media (max-width: 576px) {
        .table th:nth-child(2),
        .table td:nth-child(2) {
            display: none;
        }
        
        .table th:nth-child(4),
        .table td:nth-child(4) {
            display: none;
        }
        
        .table th,
        .table td {
            padding: 0.375rem 0.125rem;
        }
        
        .club-name {
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .club-location {
            font-size: 0.8rem;
            color: #6c757d;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4><i class="fas fa-school"></i> Школы и клубы</h4>
                <div class="d-flex align-items-center">
                    <input type="text" id="searchInput" class="form-control me-2" placeholder="Поиск по названию школы (гибкий поиск, любой регистр)..." style="width: 300px;">
                    <span class="badge bg-primary" id="clubsCount">0 школ</span>
                </div>
            </div>
            <div class="card-body">
                <div id="loadingSpinner" class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2 text-muted">Загрузка данных...</p>
                </div>
                
                <div id="clubsTable" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>№</th>
                                    <th class="sortable" data-sort="name">
                                        Название школы/клуба <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="text-center sortable" data-sort="athlete_count">
                                        Спортсменов <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="text-center sortable" data-sort="participation_count">
                                        Участий <i class="fas fa-sort"></i>
                                    </th>
                                    <th class="text-center">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="clubsTableBody">
                                <!-- Данные загружаются через AJAX -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="noResults" class="text-center py-5" style="display: none;">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Школы не найдены</h5>
                    <p class="text-muted">Попробуйте изменить поисковый запрос</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allClubs = [];
let filteredClubs = [];
let currentSort = { by: 'athlete_count', order: 'desc' };

document.addEventListener('DOMContentLoaded', function() {
    loadClubs();
    
    // Поиск в реальном времени
    document.getElementById('searchInput').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        filterClubs(searchTerm);
    });
    
    // Обработка кликов по заголовкам для сортировки
    document.querySelectorAll('.sortable').forEach(header => {
        header.style.cursor = 'pointer';
        header.addEventListener('click', function() {
            const sortBy = this.dataset.sort;
            let newOrder = 'asc';
            
            // Если кликаем по тому же столбцу, меняем порядок
            if (currentSort.by === sortBy) {
                newOrder = currentSort.order === 'asc' ? 'desc' : 'asc';
            }
            
            currentSort = { by: sortBy, order: newOrder };
            
            // Обновляем иконки сортировки
            updateSortIcons(sortBy, newOrder);
            
            // Сортируем и отображаем данные
            sortAndDisplayClubs();
        });
    });
});

function loadClubs() {
    fetch('/api/clubs')
        .then(response => response.json())
        .then(data => {
            allClubs = data;
            filteredClubs = [...allClubs];
            sortAndDisplayClubs();
            updateCount();
            hideLoading();
        })
        .catch(error => {
            console.error('Ошибка загрузки клубов:', error);
            hideLoading();
            showError();
        });
}

function filterClubs(searchTerm) {
    if (!searchTerm) {
        filteredClubs = [...allClubs];
    } else {
        filteredClubs = filterBySearch(allClubs, searchTerm, ['name']);
    }
    
    sortAndDisplayClubs();
    updateCount();
}

function sortAndDisplayClubs() {
    // Сортируем отфильтрованные данные
    filteredClubs.sort((a, b) => {
        let aVal, bVal;
        
        switch (currentSort.by) {
            case 'name':
                aVal = a.name.toLowerCase();
                bVal = b.name.toLowerCase();
                break;
            case 'athlete_count':
                aVal = a.athlete_count;
                bVal = b.athlete_count;
                break;
            case 'participation_count':
                aVal = a.participation_count;
                bVal = b.participation_count;
                break;
            default:
                return 0;
        }
        
        if (currentSort.order === 'asc') {
            return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
        } else {
            return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
        }
    });
    
    displayClubs();
}

function displayClubs() {
    const tbody = document.getElementById('clubsTableBody');
    const noResults = document.getElementById('noResults');
    const clubsTable = document.getElementById('clubsTable');
    
    if (filteredClubs.length === 0) {
        clubsTable.style.display = 'none';
        noResults.style.display = 'block';
        return;
    }
    
    clubsTable.style.display = 'block';
    noResults.style.display = 'none';
    
    let html = '';
    filteredClubs.forEach((club, index) => {
        html += `
            <tr>
                <td>${index + 1}</td>
                <td>
                    <strong>${club.name}</strong>
                </td>
                <td class="text-center">
                    <span class="badge bg-primary">${club.athlete_count}</span>
                </td>
                <td class="text-center">
                    <span class="badge bg-success">${club.participation_count}</span>
                </td>
                <td class="text-center">
                    <a href="/club/${club.id}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-eye"></i> Подробнее
                    </a>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

function updateCount() {
    const countElement = document.getElementById('clubsCount');
    const total = allClubs.length;
    const filtered = filteredClubs.length;
    
    if (filtered === total) {
        countElement.textContent = `${total} школ`;
    } else {
        countElement.textContent = `${filtered} из ${total} школ`;
    }
}

function hideLoading() {
    document.getElementById('loadingSpinner').style.display = 'none';
}

function showError() {
    const loadingSpinner = document.getElementById('loadingSpinner');
    loadingSpinner.innerHTML = `
        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
        <h5 class="text-danger">Ошибка загрузки</h5>
        <p class="text-muted">Не удалось загрузить данные о школах</p>
        <button class="btn btn-primary" onclick="loadClubs()">
            <i class="fas fa-refresh"></i> Попробовать снова
        </button>
    `;
}

function updateSortIcons(activeSort, order) {
    document.querySelectorAll('.sortable i').forEach(icon => {
        icon.className = 'fas fa-sort';
    });
    
    const activeHeader = document.querySelector(`[data-sort="${activeSort}"] i`);
    if (activeHeader) {
        activeHeader.className = order === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
    }
}
</script>
{% endblock %}
