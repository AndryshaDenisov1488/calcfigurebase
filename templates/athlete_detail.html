{% extends "base.html" %}

{% block title %}{{ athlete.last_name }} {{ athlete.first_name }} - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—É—Ä–Ω–∏—Ä–∞–º–∏{% endblock %}

{% block extra_css %}
<style>
    /* –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω 2026 - –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã, Glassmorphism, –ê–Ω–∏–º–∞—Ü–∏–∏ */
    :root {
        --primary-gradient: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        --success-gradient: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        --info-gradient: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%);
        --warning-gradient: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        --glass-bg: rgba(255, 255, 255, 0.25);
        --glass-border: rgba(255, 255, 255, 0.18);
    }
    
    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
    }
    
    /* Glassmorphism –∫–∞—Ä—Ç–æ—á–∫–∏ */
    .card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        border-radius: 16px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
    }
    
    .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.25);
    }
    
    .card-header {
        background: var(--primary-gradient);
        color: white;
        border: none;
        padding: 1.25rem 1.5rem;
        font-weight: 600;
        letter-spacing: 0.5px;
    }
    
    .card-header h4, .card-header h5 {
        margin: 0;
        font-weight: 600;
    }
    
    /* –ê–≤–∞—Ç–∞—Ä —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º */
    .athlete-avatar {
        position: relative;
        display: inline-block;
    }
    
    .athlete-avatar i {
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        filter: drop-shadow(0 4px 8px rgba(0, 123, 255, 0.3));
        transition: transform 0.3s ease;
    }
    
    .athlete-avatar:hover i {
        transform: scale(1.1);
    }
    
    /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞–º–∏ */
    .stat-item {
        padding: 1rem;
        border-radius: 12px;
        background: linear-gradient(135deg, rgba(0, 123, 255, 0.1) 0%, rgba(0, 86, 179, 0.1) 100%);
        transition: all 0.3s ease;
    }
    
    .stat-item:hover {
        background: linear-gradient(135deg, rgba(0, 123, 255, 0.2) 0%, rgba(0, 86, 179, 0.2) 100%);
        transform: scale(1.05);
    }
    
    .stat-item h4 {
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    /* –ú–µ–¥–∞–ª–∏ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º */
    .medal {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .medal::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s;
    }
    
    .medal:hover::before {
        left: 100%;
    }
    
    .medal:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }
    
    .medal.gold {
        background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        color: #000;
    }
    
    .medal.silver {
        background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
        color: #000;
    }
    
    .medal.bronze {
        background: linear-gradient(135deg, #cd7f32 0%, #e6a857 100%);
        color: #000;
    }
    
    /* –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ */
    .table {
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .table thead th {
        background: var(--primary-gradient);
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
        border: none;
        padding: 1rem;
    }
    
    .table tbody tr {
        transition: all 0.2s ease;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .table tbody tr:hover {
        background: rgba(0, 123, 255, 0.05);
        transform: scale(1.01);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .table tbody td {
        padding: 1rem;
        vertical-align: middle;
    }
    
    /* Badge —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞–º–∏ */
    .badge {
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.85rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .bg-success {
        background: var(--success-gradient) !important;
    }
    
    .bg-primary {
        background: var(--primary-gradient) !important;
    }
    
    .bg-info {
        background: var(--info-gradient) !important;
    }
    
    .bg-warning {
        background: var(--warning-gradient) !important;
    }
    
    /* –ì—Ä–∞—Ñ–∏–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    .chart-container {
        position: relative;
        height: 300px;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 12px;
        backdrop-filter: blur(5px);
    }
    
    /* Info items —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º */
    .athlete-info .info-item {
        padding: 1rem;
        margin-bottom: 0.75rem;
        background: rgba(255, 255, 255, 0.6);
        border-radius: 12px;
        border-left: 4px solid transparent;
        transition: all 0.3s ease;
    }
    
    .athlete-info .info-item:hover {
        background: rgba(255, 255, 255, 0.9);
        border-left-color: #007bff;
        transform: translateX(4px);
    }
    
    .athlete-info .info-item strong {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #495057;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .athlete-info .info-item strong i {
        color: #007bff;
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .card {
        animation: fadeInUp 0.6s ease-out;
    }
    
    .card:nth-child(1) { animation-delay: 0.1s; }
    .card:nth-child(2) { animation-delay: 0.2s; }
    .card:nth-child(3) { animation-delay: 0.3s; }
    
    /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞ */
    @media (max-width: 768px) {
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .col-lg-4,
        .col-lg-8 {
            margin-bottom: 1.5rem;
        }
        
        .athlete-avatar i {
            font-size: 4rem !important;
        }
        
        .athlete-info .info-item {
            margin-bottom: 0.75rem;
            padding: 0.75rem;
        }
        
        .athlete-info .info-item strong {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .table-responsive {
            font-size: 0.875rem;
        }
        
        .table thead th {
            padding: 0.75rem 0.5rem;
            font-size: 0.8rem;
        }
        
        .table tbody td {
            padding: 0.75rem 0.5rem;
        }
        
        .badge {
            font-size: 0.75rem;
            padding: 0.375rem 0.625rem;
        }
        
        .chart-container {
            height: 250px;
            padding: 0.75rem;
        }
        
        .stat-item {
            padding: 0.75rem;
        }
        
        .stat-item h4 {
            font-size: 1.5rem;
        }
    }
    
    @media (max-width: 576px) {
        .table th:nth-child(3),
        .table td:nth-child(3) {
            display: none;
        }
        
        .table th:nth-child(4),
        .table td:nth-child(4) {
            display: none;
        }
        
        .table thead th,
        .table tbody td {
            padding: 0.5rem 0.25rem;
            font-size: 0.8rem;
        }
        
        .athlete-avatar i {
            font-size: 3rem !important;
        }
        
        .athlete-info .info-item {
            padding: 0.5rem;
            font-size: 0.875rem;
        }
        
        .chart-container {
            height: 200px;
            padding: 0.5rem;
        }
        
        .card-body {
            padding: 1rem;
        }
        
        .card-header {
            padding: 1rem;
        }
        
        .card-header h4,
        .card-header h5 {
            font-size: 1.1rem;
        }
        
        .stat-item h4 {
            font-size: 1.25rem;
        }
    }
    
    /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞ */
    .athlete-info .info-item {
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #eee;
    }
    .athlete-info .info-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    .bg-pink {
        background-color: #007bff !important; /* –ó–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ —Å–∏–Ω–∏–π */
        color: white;
    }
    .bg-blue {
        background-color: #2196f3 !important;
        color: white;
    }
    .medals {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    .medal {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
    }
    .medal.gold { background-color: #ffd700; color: #000; }
    .medal.silver { background-color: #c0c0c0; color: #000; }
    .medal.bronze { background-color: #cd7f32; color: #000; }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞—Å–ø–µ—á–∞—Ç–∫–∏ */
    .printout-container {
        background: #fff;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 1.5rem;
        margin: 1rem 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .printout-header {
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .printout-header h5 {
        margin: 0;
        font-weight: 600;
        color: #212529;
    }
    
    .printout-header .event-info {
        color: #6c757d;
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }
    
    .printout-summary {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .printout-summary table {
        width: 100%;
        margin: 0;
    }
    
    .printout-summary td {
        padding: 0.5rem;
        border: 1px solid #dee2e6;
        font-weight: 500;
    }
    
    .printout-summary td:first-child {
        background: #e9ecef;
        font-weight: 600;
        width: 40%;
    }
    
    .printout-section {
        margin-bottom: 2rem;
    }
    
    .printout-section h6 {
        background: #007bff;
        color: white;
        padding: 0.75rem 1rem;
        margin: 0 0 1rem 0;
        border-radius: 4px;
        font-weight: 600;
        font-size: 0.95rem;
    }
    
    .printout-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
        margin-bottom: 1rem;
    }
    
    .printout-table th {
        background: #007bff;
        color: white;
        padding: 0.75rem 0.5rem;
        text-align: center;
        font-weight: 600;
        border: 1px solid #0056b3;
        font-size: 0.8rem;
    }
    
    .printout-table td {
        padding: 0.5rem;
        text-align: center;
        border: 1px solid #dee2e6;
        vertical-align: middle;
    }
    
    .printout-table tbody tr:nth-child(even) {
        background: #f8f9fa;
    }
    
    .printout-table tbody tr:hover {
        background: #e9ecef;
    }
    
    .printout-table .element-code {
        font-weight: 600;
        font-family: 'Courier New', monospace;
        color: #007bff;
    }
    
    .printout-table .score-value {
        font-weight: 600;
        color: #212529;
    }
    
    .printout-table .judge-score {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .printout-total {
        background: #e9ecef;
        font-weight: 700;
        font-size: 1rem;
    }
    
    .toggle-printout {
        transition: transform 0.3s ease;
    }
    
    .toggle-printout.expanded {
        transform: rotate(180deg);
    }
    
    .printout-row {
        background: #f8f9fa;
    }
    
    .printout-error {
        color: #dc3545;
        padding: 1rem;
        text-align: center;
        background: #f8d7da;
        border-radius: 4px;
        border: 1px solid #f5c6cb;
    }
    
    @media (max-width: 768px) {
        .printout-container {
            padding: 1rem;
        }
        
        .printout-table {
            font-size: 0.75rem;
        }
        
        .printout-table th,
        .printout-table td {
            padding: 0.375rem 0.25rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è JavaScript -->
<div id="athleteData" data-athlete-id="{{ athlete.id }}" style="display: none;"></div>

<div class="row">
    <div class="col-lg-4">
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–µ -->
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-user"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–µ</h4>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <div class="athlete-avatar">
                        <i class="fas fa-user-circle fa-5x text-primary"></i>
                    </div>
                    <h5 class="mt-2">{{ athlete.full_name or (athlete.last_name + ' ' + athlete.first_name) }}</h5>
                    {% if athlete.patronymic %}
                        <p class="text-muted">{{ athlete.patronymic }}</p>
                    {% endif %}
                </div>
                
                <hr>
                
                <div class="athlete-info">
                    <div class="info-item">
                        <strong><i class="fas fa-birthday-cake"></i> –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</strong>
                        <span>{{ athlete.birth_date.strftime('%d.%m.%Y') if athlete.birth_date else '–ù–µ —É–∫–∞–∑–∞–Ω–∞' }}</span>
                    </div>
                    
                    <div class="info-item">
                        <strong><i class="fas fa-venus-mars"></i> –ü–æ–ª:</strong>
                        <span>
                            {% if athlete.gender == 'F' %}
                                <span class="badge" style="background-color: #007bff; color: white;">–ñ–µ–Ω—Å–∫–∏–π</span>
                            {% elif athlete.gender == 'M' %}
                                <span class="badge" style="background-color: #007bff; color: white;">–ú—É–∂—Å–∫–æ–π</span>
                            {% elif athlete.gender == 'P' %}
                                <span class="badge" style="background-color: #007bff; color: white;"><i class="fas fa-user-friends"></i> –ü–∞—Ä–∞</span>
                            {% else %}
                                <span class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω</span>
                            {% endif %}
                        </span>
                    </div>
                    
                    <div class="info-item">
                        <strong><i class="fas fa-building"></i> –ö–ª—É–±:</strong>
                        <span>
                            {% if athlete.club %}
                                <a href="{{ url_for('public.club_detail', club_id=athlete.club.id) }}" class="text-decoration-none">
                                    {{ athlete.club.name }}
                                </a>
                            {% else %}
                                <span class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω</span>
                            {% endif %}
                        </span>
                    </div>
                    
                    {% if coach %}
                    <div class="info-item">
                        <strong><i class="fas fa-user-tie"></i> –¢—Ä–µ–Ω–µ—Ä:</strong>
                        <span>
                            {% if coach_id %}
                                <a href="{{ url_for('public.coach_detail', coach_id=coach_id) }}" class="text-decoration-none" style="color: #007bff; font-weight: 600;">
                                    {{ coach }}
                                </a>
                            {% else %}
                                {{ coach }}
                            {% endif %}
                        </span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="stat-item">
                            <h4 class="text-primary">{{ participations|length }}</h4>
                            <small class="text-muted">–£—á–∞—Å—Ç–∏–π</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="stat-item">
                            <h4 class="text-success">
                                {% set best_place = participations|selectattr('2.total_place')|map(attribute='2.total_place')|select|min %}
                                {{ best_place if best_place else '-' }}
                            </h4>
                            <small class="text-muted">–õ—É—á—à–µ–µ –º–µ—Å—Ç–æ</small>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <h6><i class="fas fa-trophy"></i> –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h6>
                {% set medals = {'1': 0, '2': 0, '3': 0} %}
                {% for event, category, participant in participations %}
                    {% if participant.total_place == 1 %}
                        {% set _ = medals.update({'1': medals['1'] + 1}) %}
                    {% elif participant.total_place == 2 %}
                        {% set _ = medals.update({'2': medals['2'] + 1}) %}
                    {% elif participant.total_place == 3 %}
                        {% set _ = medals.update({'3': medals['3'] + 1}) %}
                    {% endif %}
                {% endfor %}
                
                <div class="medals">
                    {% if medals['1'] > 0 %}
                        <span class="medal gold">
                            <i class="fas fa-medal"></i> {{ medals['1'] }} –∑–æ–ª–æ—Ç–æ
                        </span>
                    {% endif %}
                    {% if medals['2'] > 0 %}
                        <span class="medal silver">
                            <i class="fas fa-medal"></i> {{ medals['2'] }} —Å–µ—Ä–µ–±—Ä–æ
                        </span>
                    {% endif %}
                    {% if medals['3'] > 0 %}
                        <span class="medal bronze">
                            <i class="fas fa-medal"></i> {{ medals['3'] }} –±—Ä–æ–Ω–∑–∞
                        </span>
                    {% endif %}
                    {% if medals['1'] == 0 and medals['2'] == 0 and medals['3'] == 0 %}
                        <p class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –º–µ–¥–∞–ª–µ–π</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-8">
        <!-- –ì—Ä–∞—Ñ–∏–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
        <div class="card mb-4">
            <div class="card-header">
                <h4><i class="fas fa-chart-line"></i> –ì—Ä–∞—Ñ–∏–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h4>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6>–ú–µ—Å—Ç–∞ –≤ —Ç—É—Ä–Ω–∏—Ä–∞—Ö</h6>
                        <div class="chart-container">
                            <canvas id="placesChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>–ë–∞–ª–ª—ã –≤ —Ç—É—Ä–Ω–∏—Ä–∞—Ö</h6>
                        <div class="chart-container">
                            <canvas id="pointsChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="text-muted">
                    <small><i class="fas fa-info-circle"></i> –ì—Ä–∞—Ñ–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∏–Ω–∞–º–∏–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞ –ø–æ —Ç—É—Ä–Ω–∏—Ä–∞–º</small>
                </div>
            </div>
        </div>
        
        <!-- –ò—Å—Ç–æ—Ä–∏—è –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–π -->
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–π</h4>
            </div>
            <div class="card-body">
                {% if participations %}
                    <div class="table-responsive" style="overflow-x: auto; width: 100%;">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 30px;"></th>
                                    <th>–¢—É—Ä–Ω–∏—Ä</th>
                                    <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–ú–µ—Å—Ç–æ</th>
                                    <th>–ë–∞–ª–ª—ã</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for event, category, participant in participations %}
                                <tr data-participant-id="{{ participant.id }}" {% if participant.pct_ppname == '–ë–ï–°–ü' %}class="table-success"{% elif participant.status == 'R' or participant.status == 'W' %}class="table-warning"{% endif %}>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary toggle-printout" 
                                                data-participant-id="{{ participant.id }}"
                                                title="–ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞—Å–ø–µ—á–∞—Ç–∫—É">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </td>
                                    <td>
                                        <strong>{{ event.name }}</strong>
                                        {% if event.place %}
                                            <br><small class="text-muted">{{ event.place }}</small>
                                        {% endif %}
                                        {% if participant.pct_ppname == '–ë–ï–°–ü' %}
                                            <br><small class="badge bg-success"><i class="fas fa-gift"></i> –ë–µ—Å–ø–ª–∞—Ç–Ω–æ–µ —É—á–∞—Å—Ç–∏–µ</small>
                                        {% endif %}
                                        {% if participant.status == 'R' or participant.status == 'W' %}
                                            <br><small class="badge bg-warning text-dark"><i class="fas fa-ban"></i> –°–Ω—è—Ç–∞ —Å —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–π</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ category.name }}</span>
                                    </td>
                                    <td>
                                        {% if event.begin_date %}
                                            {{ event.begin_date.strftime('%d.%m.%Y') }}
                                            {% if event.end_date and event.end_date != event.begin_date %}
                                                <br><small class="text-muted">–¥–æ {{ event.end_date.strftime('%d.%m.%Y') }}</small>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if participant.total_place %}
                                            <span class="badge bg-{{ 'success' if participant.total_place <= 3 else 'primary' }}">
                                                {{ participant.total_place }}
                                            </span>
                                        {% else %}
                                            {% if participant.status == 'R' or participant.status == 'W' %}
                                                <span class="badge bg-warning text-dark" title="–°–Ω—è—Ç–∞ —Å —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–π">
                                                    <i class="fas fa-ban"></i> –°–Ω—è—Ç–∞
                                                </span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if participant.total_points %}
                                            <strong>{{ (participant.total_points)|round(2) }}</strong>
                                        {% else %}
                                            {% if participant.status == 'R' or participant.status == 'W' %}
                                                <span class="text-muted" title="–°–Ω—è—Ç–∞ —Å —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–π">-</span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr class="printout-row" data-participant-id="{{ participant.id }}" style="display: none;">
                                    <td colspan="6">
                                        <div class="printout-container" data-participant-id="{{ participant.id }}">
                                            <div class="text-center py-3">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                                </div>
                                                <p class="mt-2 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–µ—á–∞—Ç–∫–∏...</p>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-history fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">–ò—Å—Ç–æ—Ä–∏—è –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–π –ø—É—Å—Ç–∞</h5>
                        <p class="text-muted">–°–ø–æ—Ä—Ç—Å–º–µ–Ω –µ—â–µ –Ω–µ —É—á–∞—Å—Ç–≤–æ–≤–∞–ª –≤ —Ç—É—Ä–Ω–∏—Ä–∞—Ö</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}



{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ü–æ–ª—É—á–∞–µ–º ID —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞
    const athleteData = document.getElementById('athleteData');
    const athleteId = parseInt(athleteData.dataset.athleteId);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
    fetch(`/api/athlete/${athleteId}/results-chart`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data || data.labels.length === 0) {
                // –°–∫—Ä—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
                const chartCard = document.querySelector('.card.mb-4');
                if (chartCard) {
                    chartCard.style.display = 'none';
                }
                return;
            }
            
            const placeValues = data.places
                .map(value => (value === null || value === undefined ? null : Number(value)))
                .filter(value => Number.isFinite(value));
            const maxPlace = placeValues.length ? Math.max(...placeValues) : 1;
            const minPlace = placeValues.length ? Math.min(...placeValues) : 1;

            // –ì—Ä–∞—Ñ–∏–∫ –º–µ—Å—Ç —Å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º
            const placesCtx = document.getElementById('placesChart').getContext('2d');
            const placesGradient = placesCtx.createLinearGradient(0, 0, 0, 300);
            placesGradient.addColorStop(0, 'rgba(0, 123, 255, 0.3)');
            placesGradient.addColorStop(1, 'rgba(0, 123, 255, 0.05)');
            
            new Chart(placesCtx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: '–ú–µ—Å—Ç–æ',
                        data: data.places,
                        borderColor: '#007bff',
                        backgroundColor: placesGradient,
                        tension: 0.5,
                        fill: true,
                        pointBackgroundColor: '#007bff',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 3,
                        pointRadius: 7,
                        pointHoverRadius: 9,
                        pointHoverBackgroundColor: '#0056b3',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            reverse: true, // –õ—É—á—à–∏–µ –º–µ—Å—Ç–∞ (1) —Å–≤–µ—Ä—Ö—É
                            min: Math.min(1, minPlace),
                            max: Math.max(1, maxPlace),
                            grid: {
                                color: 'rgba(0, 123, 255, 0.1)',
                                lineWidth: 1
                            },
                            ticks: {
                                stepSize: 1, // –¢–æ–ª—å–∫–æ —Ü–µ–ª—ã–µ —á–∏—Å–ª–∞
                                callback: function(value) {
                                    return Number.isInteger(value) ? value : null;
                                },
                                font: {
                                    size: 11,
                                    weight: '600'
                                },
                                color: '#007bff'
                            },
                            title: {
                                display: true,
                                text: '–ú–µ—Å—Ç–æ',
                                font: {
                                    size: 12,
                                    weight: '600'
                                },
                                color: '#007bff'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 10
                                },
                                color: '#6c757d'
                            },
                            title: {
                                display: true,
                                text: '–î–∞—Ç–∞ —Ç—É—Ä–Ω–∏—Ä–∞',
                                font: {
                                    size: 12,
                                    weight: '600'
                                },
                                color: '#6c757d'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 123, 255, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#0056b3',
                            borderWidth: 2,
                            padding: 12,
                            cornerRadius: 8,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    return data.tournaments[index];
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    return [
                                        `üèÜ –ú–µ—Å—Ç–æ: ${context.parsed.y}`,
                                        `üìã –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${data.categories[index]}`,
                                        `üìÖ –°–µ–∑–æ–Ω: ${data.seasons[index]}`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
            
            // –ì—Ä–∞—Ñ–∏–∫ –±–∞–ª–ª–æ–≤ —Å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º
            const pointsCtx = document.getElementById('pointsChart').getContext('2d');
            const pointsGradient = pointsCtx.createLinearGradient(0, 0, 0, 300);
            pointsGradient.addColorStop(0, 'rgba(23, 162, 184, 0.3)');
            pointsGradient.addColorStop(1, 'rgba(23, 162, 184, 0.05)');
            
            new Chart(pointsCtx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: '–ë–∞–ª–ª—ã',
                        data: data.points,
                        borderColor: '#17a2b8',
                        backgroundColor: pointsGradient,
                        tension: 0.5,
                        fill: true,
                        pointBackgroundColor: '#17a2b8',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 3,
                        pointRadius: 7,
                        pointHoverRadius: 9,
                        pointHoverBackgroundColor: '#117a8b',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(23, 162, 184, 0.1)',
                                lineWidth: 1
                            },
                            ticks: {
                                font: {
                                    size: 11,
                                    weight: '600'
                                },
                                color: '#17a2b8'
                            },
                            title: {
                                display: true,
                                text: '–ë–∞–ª–ª—ã',
                                font: {
                                    size: 12,
                                    weight: '600'
                                },
                                color: '#17a2b8'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 10
                                },
                                color: '#6c757d'
                            },
                            title: {
                                display: true,
                                text: '–î–∞—Ç–∞ —Ç—É—Ä–Ω–∏—Ä–∞',
                                font: {
                                    size: 12,
                                    weight: '600'
                                },
                                color: '#6c757d'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(23, 162, 184, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#117a8b',
                            borderWidth: 2,
                            padding: 12,
                            cornerRadius: 8,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    return data.tournaments[index];
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    return [
                                        `‚≠ê –ë–∞–ª–ª—ã: ${context.parsed.y.toFixed(2)}`,
                                        `üìã –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${data.categories[index]}`,
                                        `üìÖ –°–µ–∑–æ–Ω: ${data.seasons[index]}`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞:', error);
            // –°–∫—Ä—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            const chartCard = document.querySelector('.card.mb-4');
            if (chartCard) {
                chartCard.style.display = 'none';
            }
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            const errorMessage = document.createElement('div');
            errorMessage.className = 'alert alert-warning';
            errorMessage.innerHTML = '<i class="fas fa-exclamation-triangle"></i> –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤';
            chartCard.parentNode.insertBefore(errorMessage, chartCard);
        });
    
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–µ—á–∞—Ç–∫–æ–π –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–π
    const toggleButtons = document.querySelectorAll('.toggle-printout');
    const loadedPrintouts = new Set(); // –•—Ä–∞–Ω–∏–º ID —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ä–∞—Å–ø–µ—á–∞—Ç–æ–∫
    
    toggleButtons.forEach(button => {
        button.addEventListener('click', function() {
            const participantId = this.dataset.participantId;
            const printoutRow = document.querySelector(`tr.printout-row[data-participant-id="${participantId}"]`);
            const container = document.querySelector(`.printout-container[data-participant-id="${participantId}"]`);
            
            if (!printoutRow || !container) return;
            
            const isExpanded = printoutRow.style.display !== 'none';
            
            if (isExpanded) {
                // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º
                printoutRow.style.display = 'none';
                this.classList.remove('expanded');
                this.querySelector('i').classList.remove('fa-chevron-up');
                this.querySelector('i').classList.add('fa-chevron-down');
            } else {
                // –†–∞—Å–∫—Ä—ã–≤–∞–µ–º
                printoutRow.style.display = 'table-row';
                this.classList.add('expanded');
                this.querySelector('i').classList.remove('fa-chevron-down');
                this.querySelector('i').classList.add('fa-chevron-up');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
                if (!loadedPrintouts.has(participantId)) {
                    loadPrintoutData(participantId, container);
                }
            }
        });
    });
    
    function loadPrintoutData(participantId, container) {
        fetch(`/api/participant/${participantId}/performance-details`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                loadedPrintouts.add(participantId);
                renderPrintout(data, container);
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø–µ—á–∞—Ç–∫–∏:', error);
                container.innerHTML = `
                    <div class="printout-error">
                        <i class="fas fa-exclamation-triangle"></i> 
                        –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ä–∞—Å–ø–µ—á–∞—Ç–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.
                    </div>
                `;
            });
    }
    
    function renderPrintout(data, container) {
        const { participant, event, category, athlete, performances } = data;
        
        let html = `
            <div class="printout-header">
                <h5>${event.name}</h5>
                <div class="event-info">
                    ${event.begin_date ? event.begin_date : ''}${event.end_date && event.end_date !== event.begin_date ? ' - ' + event.end_date : ''}
                    ${event.place ? ' ‚Ä¢ ' + event.place : ''}
                </div>
                <div class="event-info mt-2">
                    <strong>${category.name}</strong> ‚Ä¢ ${athlete.full_name}${athlete.club_name ? ' ‚Ä¢ ' + athlete.club_name : ''}
                </div>
            </div>
            
            <div class="printout-summary">
                <table>
                    <tr>
                        <td>–°—Ç–∞—Ä—Ç. –Ω–æ–º–µ—Ä</td>
                        <td>${participant.bib_number || '-'}</td>
                    </tr>
                    <tr>
                        <td>–û–±—â–∞—è —Å—É–º–º–∞ –∑–∞ –≤–∏–¥</td>
                        <td><strong>${participant.total_points !== null ? participant.total_points.toFixed(2) : '-'}</strong></td>
                    </tr>
                    <tr>
                        <td>–ú–µ—Å—Ç–æ</td>
                        <td><strong>${participant.total_place || '-'}</strong></td>
                    </tr>
                </table>
            </div>
        `;
        
        // –†–µ–Ω–¥–µ—Ä–∏–º –∫–∞–∂–¥–æ–µ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ (—Å–µ–≥–º–µ–Ω—Ç)
        performances.forEach((perf, perfIndex) => {
            html += `
                <div class="printout-section">
                    <h6>${perf.segment_name}</h6>
            `;
            
            // –≠–ª–µ–º–µ–Ω—Ç—ã
            if (perf.elements && perf.elements.length > 0) {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—É–¥–µ–π —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                let maxJudges = 0;
                perf.elements.forEach(elem => {
                    const judgeCount = (elem.judge_scores || []).length;
                    if (judgeCount > maxJudges) {
                        maxJudges = judgeCount;
                    }
                });
                
                // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å—É–¥–µ–π
                let headerRow = `
                    <tr>
                        <th>#</th>
                        <th>–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã</th>
                        <th>Info</th>
                        <th>–ë–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</th>
                        <th>GOE</th>
                `;
                for (let j = 1; j <= maxJudges; j++) {
                    headerRow += `<th>J${j}</th>`;
                }
                headerRow += `<th>–û—Ü–µ–Ω–∫–∞ –±—Ä–∏–≥–∞–¥—ã</th></tr>`;
                
                html += `
                    <h6 style="background: #28a745; margin-top: 1rem;">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã</h6>
                    <table class="printout-table">
                        <thead>
                            ${headerRow}
                        </thead>
                        <tbody>
                `;
                
                perf.elements.forEach((elem, index) => {
                    const judgeScores = elem.judge_scores || [];
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –±–æ–Ω—É—Å –∑–∞ –≤—Ç–æ—Ä—É—é –ø–æ–ª–æ–≤–∏–Ω—É –ø—Ä–æ–≥—Ä–∞–º–º—ã
                    const isSecondHalf = elem.is_second_half || false;
                    const baseValueDisplay = elem.base_value !== null 
                        ? `${elem.base_value.toFixed(2)}${isSecondHalf ? ' x' : ''}` 
                        : '-';
                    
                    let row = `
                        <tr>
                            <td>${elem.order_num || index + 1}</td>
                            <td class="element-code">${elem.executed_code || '-'}</td>
                            <td>${elem.info_code || ''}</td>
                            <td>${baseValueDisplay}</td>
                            <td>${elem.goe_result !== null ? (elem.goe_result >= 0 ? '+' : '') + elem.goe_result.toFixed(2) : '-'}</td>
                    `;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —è—á–µ–π–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Å—É–¥–µ–π
                    for (let j = 0; j < maxJudges; j++) {
                        const score = judgeScores[j];
                        if (score !== undefined && score !== null) {
                            const displayScore = Math.round(score);
                            row += `<td class="judge-score">${displayScore >= 0 ? '+' : ''}${displayScore}</td>`;
                        } else {
                            row += `<td class="judge-score">-</td>`;
                        }
                    }
                    
                    row += `<td class="score-value">${elem.result !== null ? elem.result.toFixed(2) : '-'}</td></tr>`;
                    html += row;
                });
                
                // –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (5 –±–∞–∑–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ + —Å—É–¥—å–∏ + –∏—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞)
                const totalColspan = 5 + maxJudges + 1;
                html += `
                        <tr class="printout-total">
                            <td colspan="${totalColspan}"><strong>–°—É–º–º–∞ –≤ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –æ—Ü–µ–Ω–∫–µ</strong></td>
                            <td><strong>${perf.tes_total !== null ? perf.tes_total.toFixed(2) : '-'}</strong></td>
                        </tr>
                    </tbody>
                </table>
                `;
            }
            
            // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã
            if (perf.components && perf.components.length > 0) {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—É–¥–µ–π —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
                let maxJudges = 0;
                perf.components.forEach(comp => {
                    const judgeCount = (comp.judge_scores || []).length;
                    if (judgeCount > maxJudges) {
                        maxJudges = judgeCount;
                    }
                });
                
                // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å—É–¥–µ–π
                let headerRow = `
                    <tr>
                        <th>–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã</th>
                        <th>–§–∞–∫—Ç–æ—Ä</th>
                `;
                for (let j = 1; j <= maxJudges; j++) {
                    headerRow += `<th>J${j}</th>`;
                }
                headerRow += `<th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th></tr>`;
                
                html += `
                    <h6 style="background: #17a2b8; margin-top: 1.5rem;">–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã</h6>
                    <table class="printout-table">
                        <thead>
                            ${headerRow}
                        </thead>
                        <tbody>
                `;
                
                perf.components.forEach(comp => {
                    const judgeScores = comp.judge_scores || [];
                    let row = `
                        <tr>
                            <td style="text-align: left;"><strong>${comp.name}</strong></td>
                            <td>${comp.factor !== null ? comp.factor.toFixed(2) : '-'}</td>
                    `;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —è—á–µ–π–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Å—É–¥–µ–π
                    for (let j = 0; j < maxJudges; j++) {
                        const score = judgeScores[j];
                        if (score !== undefined && score !== null) {
                            row += `<td class="judge-score">${score.toFixed(2)}</td>`;
                        } else {
                            row += `<td class="judge-score">-</td>`;
                        }
                    }
                    
                    row += `<td class="score-value">${comp.result !== null ? comp.result.toFixed(2) : '-'}</td></tr>`;
                    html += row;
                });
                
                // –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (2 –±–∞–∑–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ + —Å—É–¥—å–∏ + –∏—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞)
                const componentTotalColspan = 2 + maxJudges + 1;
                html += `
                        <tr class="printout-total">
                            <td colspan="${componentTotalColspan}"><strong>–°—É–º–º–∞ –∑–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã (—É–º–Ω–æ–∂–µ–Ω–Ω–∞—è)</strong></td>
                            <td><strong>${perf.pcs_total !== null ? perf.pcs_total.toFixed(2) : '-'}</strong></td>
                        </tr>
                    </tbody>
                </table>
                `;
            }
            
            // –°–Ω–∏–∂–µ–Ω–∏—è
            html += `
                <div class="printout-summary" style="margin-top: 1.5rem;">
                    <table>
                        <tr>
                            <td>–û–±—â–∞—è —Å—É–º–º–∞ —Å–Ω–∏–∂–µ–Ω–∏–π</td>
                            <td><strong>${perf.deductions !== null ? perf.deductions.toFixed(2) : '0.00'}</strong></td>
                        </tr>
                        <tr style="background: #e9ecef; font-weight: 700;">
                            <td>–°—É–º–º–∞ –∑–∞ ${perf.segment_name}</td>
                            <td><strong>${perf.points !== null ? perf.points.toFixed(2) : '-'}</strong></td>
                        </tr>
                    </table>
                </div>
            `;
            
            html += `</div>`; // –ó–∞–∫—Ä—ã–≤–∞–µ–º printout-section
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É —Å —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–∞–º–º (–µ—Å–ª–∏ –∏—Ö –Ω–µ—Å–∫–æ–ª—å–∫–æ)
        if (performances.length > 1) {
            const segmentSums = performances
                .filter(p => p.points !== null)
                .map(p => parseFloat(p.points));
            const calculatedTotal = segmentSums.reduce((sum, val) => sum + val, 0);
            
            html += `
                <div class="printout-summary" style="margin-top: 2rem; background: #f8f9fa; border: 2px solid #007bff;">
                    <h6 style="background: #007bff; color: white; padding: 0.75rem 1rem; margin: -1rem -1rem 1rem -1rem; border-radius: 4px 4px 0 0;">
                        <i class="fas fa-calculator"></i> –†–∞—Å—á–µ—Ç –æ–±—â–µ–π —Å—É–º–º—ã –∑–∞ –≤–∏–¥
                    </h6>
                    <table style="width: 100%;">
            `;
            
            performances.forEach((perf, idx) => {
                if (perf.points !== null) {
                    html += `
                        <tr>
                            <td>${perf.segment_name}:</td>
                            <td style="text-align: right; font-weight: 600;">${perf.points.toFixed(2)}</td>
                        </tr>
                    `;
                }
            });
            
            html += `
                        <tr style="background: #007bff; color: white; font-weight: 700; font-size: 1.1rem;">
                            <td>–û–±—â–∞—è —Å—É–º–º–∞ –∑–∞ –≤–∏–¥:</td>
                            <td style="text-align: right;">${participant.total_points !== null ? participant.total_points.toFixed(2) : calculatedTotal.toFixed(2)}</td>
                        </tr>
                    </table>
                </div>
            `;
        }
        
        container.innerHTML = html;
    }
});
</script>
{% endblock %}
