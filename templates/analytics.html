{% extends "base.html" %}

{% block title %}Аналитика - Система управления турнирами{% endblock %}

{% block extra_css %}
<style>
    /* Мобильная адаптация для страницы аналитики */
    @media (max-width: 768px) {
        .col-lg-6 {
            margin-bottom: 1rem;
        }
        
        .card {
            margin-bottom: 1rem;
        }
        
        .chart-container {
            height: 250px;
        }
        
        .stats-cards .col-6 {
            margin-bottom: 1rem;
        }
        
        .stats-cards .card {
            text-align: center;
            padding: 1rem 0.5rem;
        }
        
        .stats-cards .card h3 {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }
        
        .stats-cards .card small {
            font-size: 0.75rem;
        }
        
        .btn {
            width: 100%;
            margin-bottom: 0.5rem;
        }
        
        .table-responsive {
            font-size: 0.875rem;
        }
        
        .table th,
        .table td {
            padding: 0.5rem 0.25rem;
        }
        
        .badge {
            font-size: 0.75rem;
        }
    }
    
    @media (max-width: 576px) {
        .stats-cards .col-6 {
            flex: 0 0 100%;
            max-width: 100%;
        }
        
        .chart-container {
            height: 200px;
        }
        
        .card-body {
            padding: 0.75rem;
        }
        
        .table th,
        .table td {
            padding: 0.375rem 0.125rem;
        }
        
        .btn {
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-chart-bar"></i> Аналитика</h2>
</div>

<!-- Общая статистика -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="totalAthletes">-</h4>
                        <p class="mb-0">Спортсменов</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="totalEvents">-</h4>
                        <p class="mb-0">Турниров</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-trophy fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="totalParticipations">-</h4>
                        <p class="mb-0">Участий</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-medal fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="totalClubs">-</h4>
                        <p class="mb-0">Клубов</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-building fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Топ спортсменов -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-star"></i> Топ спортсменов по участиям</h5>
            </div>
            <div class="card-body">
                <div id="topAthletesByParticipations">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Спортсмены с бесплатным участием -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-gift text-success"></i> Спортсмены с бесплатным участием</h5>
                <a href="{{ url_for('analytics.free_participation') }}" class="btn btn-sm btn-outline-success">
                    <i class="fas fa-external-link-alt"></i> Подробнее
                </a>
            </div>
            <div class="card-body">
                <div id="freeParticipationStats">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Топ спортсменов по разрядам -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-trophy"></i> Топ спортсменов по разрядам</h5>
            </div>
            <div class="card-body">
                <div id="topAthletesByRanks">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Загрузка общей статистики
function loadGeneralStatistics() {
    fetch('/api/statistics')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalAthletes').textContent = data.total_athletes;
            document.getElementById('totalEvents').textContent = data.total_events;
            document.getElementById('totalParticipations').textContent = data.total_participations;
            document.getElementById('totalClubs').textContent = data.top_clubs.length;
        })
        .catch(error => console.error('Ошибка загрузки статистики:', error));
}

// Загрузка топ спортсменов
function loadTopAthletes() {
    fetch('/api/analytics/top-athletes')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data || data.error) {
                console.error('Ошибка в данных:', data?.error || 'Неизвестная ошибка');
                const participationsDiv = document.getElementById('topAthletesByParticipations');
                const ranksDiv = document.getElementById('topAthletesByRanks');
                if (participationsDiv) {
                    participationsDiv.innerHTML = '<p class="text-muted">Ошибка загрузки данных</p>';
                }
                if (ranksDiv) {
                    ranksDiv.innerHTML = '<p class="text-muted">Ошибка загрузки данных</p>';
                }
                return;
            }
            
            // Топ по участиям
            const participationsDiv = document.getElementById('topAthletesByParticipations');
            if (participationsDiv && data.by_participations && data.by_participations.length > 0) {
                participationsDiv.innerHTML = data.by_participations.map((athlete, index) => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="d-flex align-items-center">
                        <span class="badge bg-primary me-2">${index + 1}</span>
                        <div>
                            <a href="/athlete/${athlete.id}" class="text-decoration-none">
                                ${athlete.name}
                            </a>
                            <br><small class="text-muted">${athlete.rank}</small>
                        </div>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-info">${athlete.participations} участий</span>
                        ${athlete.best_place ? `<br><small class="text-muted">Лучшее: ${athlete.best_place} место</small>` : ''}
                    </div>
                </div>
            `).join('');
            } else if (participationsDiv) {
                participationsDiv.innerHTML = '<p class="text-muted">Нет данных</p>';
            }

            // Загружаем данные о бесплатном участии
            loadFreeParticipationStats();

            // Топ по разрядам (раскрывающиеся списки)
            const ranksDiv = document.getElementById('topAthletesByRanks');
            if (ranksDiv && data.by_ranks && data.by_ranks.length > 0) {
                ranksDiv.innerHTML = data.by_ranks.map(rank => `
                <div class="accordion mb-3" id="accordion-${rank.name.replace(/\s+/g, '-')}">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapse-${rank.name.replace(/\s+/g, '-')}" 
                                    aria-expanded="false" aria-controls="collapse-${rank.name.replace(/\s+/g, '-')}">
                                <div class="d-flex justify-content-between w-100 me-3">
                                    <span><strong>${rank.name}</strong></span>
                                    <span class="badge bg-secondary">${rank.athletes.length} спортсменов</span>
                                </div>
                            </button>
                        </h2>
                        <div id="collapse-${rank.name.replace(/\s+/g, '-')}" class="accordion-collapse collapse" 
                             data-bs-parent="#accordion-${rank.name.replace(/\s+/g, '-')}">
                            <div class="accordion-body">
                                ${rank.athletes.map((athlete, index) => `
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-primary me-2">${index + 1}</span>
                                            <div>
                                                <a href="/athlete/${athlete.id}" class="text-decoration-none">
                                                    ${athlete.name}
                                                </a>
                                                <br><small class="text-muted">${athlete.participations} участий</small>
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-warning">${athlete.best_place} место</span>
                                            <br><small class="text-muted">${athlete.best_points} баллов</small>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            } else if (ranksDiv) {
                ranksDiv.innerHTML = '<p class="text-muted">Нет данных</p>';
            }
        })
        .catch(error => {
            console.error('Ошибка загрузки топ спортсменов:', error);
            const participationsDiv = document.getElementById('topAthletesByParticipations');
            const ranksDiv = document.getElementById('topAthletesByRanks');
            if (participationsDiv) {
                participationsDiv.innerHTML = '<p class="text-danger">Ошибка загрузки данных. Обновите страницу.</p>';
            }
            if (ranksDiv) {
                ranksDiv.innerHTML = '<p class="text-danger">Ошибка загрузки данных. Обновите страницу.</p>';
            }
        });
}

// Загрузка статистики бесплатного участия
function loadFreeParticipationStats() {
    fetch('/api/analytics/free-participation')
        .then(response => response.json())
        .then(data => {
            const freeStatsDiv = document.getElementById('freeParticipationStats');
            
            if (data.athletes.length === 0) {
                freeStatsDiv.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-gift fa-2x mb-2"></i>
                        <p class="mb-0">Нет спортсменов с бесплатным участием</p>
                    </div>
                `;
                return;
            }

            // Показываем топ-5 спортсменов с бесплатным участием
            const topAthletes = data.athletes.slice(0, 5);
            freeStatsDiv.innerHTML = `
                <div class="mb-3">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="border rounded p-2">
                                <div class="fw-bold text-success">${data.total_athletes}</div>
                                <small class="text-muted">Спортсменов</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="border rounded p-2">
                                <div class="fw-bold text-info">${data.total_free_participations}</div>
                                <small class="text-muted">Участий</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="border rounded p-2">
                                <div class="fw-bold text-warning">${(data.total_free_participations / data.total_athletes).toFixed(1)}</div>
                                <small class="text-muted">Среднее</small>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <h6><i class="fas fa-star text-warning"></i> Топ-5 спортсменов:</h6>
                ${topAthletes.map((athlete, index) => `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-success me-2">${index + 1}</span>
                            <div>
                                <a href="/athlete/${athlete.id}" class="text-decoration-none">
                                    ${athlete.name}
                                </a>
                                <br><small class="text-muted">${athlete.free_participations} бесплатных участий</small>
                            </div>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-info">${athlete.events.length} турниров</span>
                        </div>
                    </div>
                `).join('')}
            `;
        })
        .catch(error => {
            console.error('Ошибка загрузки статистики бесплатного участия:', error);
            document.getElementById('freeParticipationStats').innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p class="mb-0">Ошибка загрузки данных</p>
                </div>
            `;
        });
}


// Загрузка всех данных при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadGeneralStatistics();
    loadTopAthletes();
});
</script>
{% endblock %}
